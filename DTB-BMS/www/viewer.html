<!DOCTYPE html>
<html>

<head>
    <title>DTB-BMS(Digital Twin and BIM based Building Management System)</title>

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <!-- Third Party package -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css">
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script> 

    <!-- bootstrap -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" />  
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" ></script>


    <link rel="stylesheet" href="./main.css" />  
    <script src="./dashboard/Dashboard.js"></script>  
    <script src="./dashboard/DashboardPanel.js"></script>
    <script src="./dashboard/PanelBarChart.js"></script>
    <script src="./dashboard/PanelPieChart.js"></script> 
</head>

<body>
    <!-- Custom script -->
    <h4>DTB-BMS(Digital Twin and BIM based Building Management System)</h4>
    <div class="container-fluid fill">
        <div class="row fill">               
            <div id="containViewer" class="col-sm-7 fill">          
                <div id="forgeViewer"> 
                </div>
            </div> 
        </div>
    </div>        
    <div class="container-fluid fill">
        <div class="row">       
            <div class="col-sm-12 fill">
                <br/>
                <button id="reflashSensorData" onclick="renderSensorData()">Reflash IoT sensor data</button>
                <button id="downloadSensorData" onclick="downloadSensorData()">Download data</button>                  
                <label>Date</label>
                <input id="beginDate" type="date" value="2021-03-01">
                <input id="endDate" type="date" value="2021-05-01">  
                <label>Area</label>
                <input type="text" id="area" value="all"></input>
                <label>Sensor</label>
                <select id="sensor" class="selectpicker">
                    <option value="all">all</option>
                    <option value="temperature">temperature</option>
                    <option value="humidity">humidity</option>
                    <option value="light">light</option>
                </select>                     

                <div id="sensorDataTable" class="table-responsive"></div> 
                <div id="sensorTestTable" class="table-responsive"></div>                                 
            </div>             
        </div>
    </div>

    <script type="text/javascript">
        var viewer;
        var options = {
            env: 'AutodeskProduction',
            api: 'derivativeV2', // TODO: for models uploaded to EMEA change this option to 'derivativeV2_EU'
            getAccessToken: getForgeToken
        };
        var documentId = 'urn:' + getUrlParameter('urn');
        // var documentId = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6bGlidXlrcG9xeDh0cmtveW5iYWtkZDFjNmw2ZW93aTBfdHV0b3JpYWxfYnVja2V0L1VORjkucnZ0';

        // Run this when the page is loaded
        Autodesk.Viewing.Initializer(options, function onInitialized(){
            // Find the element where the 3d viewer will live.    
            var htmlElement = document.getElementById('forgeViewer');
            this.viewerElement = htmlElement;
            if (htmlElement) {
                // Create and start the viewer in that element    
                viewer = new Autodesk.Viewing.GuiViewer3D(htmlElement);
                viewer.start();

                window.NOP_VIEWER = viewer;
                // Load the document into the viewer.
                Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
                viewer.autocam.shotParams.destinationPercent = 3;
                viewer.autocam.shotParams.duration = 3;

                calcWindowSize();
            }
        });

        function calcWindowSize() {
            console.log("calcWindowSize");   

            var style3D = "";
            /* console.log("Screen: " + window.screen.width + ", " + window.screen.availWidth);
            console.log("Window: " + document.documentElement.clientWidth + ", " + document.documentElement.clientHeight);
            console.log("Window inner: " + window.innerWidth + ", " + window.innerHeight); */
            if(window.innerWidth < 400)
                style3D = "height: 250px; width: calc(350px); overflow: hidden;";
            else if(window.innerWidth < 800)
                style3D = "height: 300px; width: calc(400px); overflow: hidden;";
            else
                style3D = "height: 400px; width: calc(1100px); overflow: hidden;";
            $('.adsk-viewing-viewer').attr('style', style3D); 
        }

        function clickTableRow(e) {
            var id = e.target.cellIndex;
            var text = e.currentTarget.cells[1].outerText;
            alert(id + ": " + text);
        }

        function renderSensorTable(responseText) {
            var htmlElement = document.getElementById('sensorDataTable');
            htmlElement.innerHTML = '';

            var table = document.createElement("table");
            table.setAttribute("class", "table table-striped table-sm table-responsive");

            var head = "<thead><tr><th>No</th><th>Area</th><th>Sensor</th><th>Time</th><th>Value</th></tr></thead>";
            table.innerHTML = head;

            var tbody = document.createElement("tbody");
                           
            var records = JSON.parse(responseText);
            for (var i = 0; i < records.length; i++) {
                var record = records[i];

                var recValues = [];
                recValues.push(i);
                recValues.push(record.area);
                recValues.push(record.sensor);
                recValues.push(record.date);
                recValues.push(record.value);               

                var row = document.createElement("tr");
                row.onclick = clickTableRow;

                for (var j = 0; j < recValues.length; j++)
                {
                    var c = document.createElement("td");
                    var t = document.createTextNode(recValues[j]);
                    c.appendChild(t);
                    row.appendChild(c);                    
                }

                tbody.appendChild(row);
            } 
            table.appendChild(tbody);
            htmlElement.appendChild(table);
        }

        function renderSensorData() {
            // Create a new ajax requst
            var oReq = new XMLHttpRequest();

            oReq.onreadystatechange = function ()
            {
                if (oReq.readyState == 4 && oReq.status == 200)
                    renderSensorTable(oReq.responseText);
            };

            // Create the connection to our API
            oReq.open("GET", "http://192.168.1.66:4000/sensors?limit=20");  // ?limit=10&date=2021
            oReq.setRequestHeader('Content-Type', 'application/json');
            oReq.send();    // Fire the request
        }

        var data = [
           ['ID', 'programmer'],
           ['P', 'taewook'],
           ['C1', 'sunwoo'],
           ['C2', 'yeonsoo']
        ];
          
        function downloadSensorData() {
            var csv = 'Name,Title\n';
            data.forEach(function(row) {
                    csv += row.join(',');
                    csv += "\n";
            });
         
            console.log(csv);
            var hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            hiddenElement.download = 'data.csv';
            hiddenElement.click();
        }

        /**
        * Autodesk.Viewing.Document.load() success callback.
        * Proceeds with model initialization.
        */
        function onDocumentLoadSuccess(doc) {
            // Load the default viewable geometry into the viewer.
            // Using the doc, we have access to the root BubbleNode,
            // which references the root node of a graph that wraps each object from the Manifest JSON.
            var viewable = doc.getRoot().getDefaultGeometry();
            if (viewable) {
                viewer.loadDocumentNode(doc, viewable).then(function(result) {
                        console.log('Viewable Loaded!');
                        initViewer(viewer);                    
                        renderSensorData();
                    }).catch(function(err) {
                        console.log('Viewable failed to load.');
                        console.log(err);
                    }
                )

                window.addEventListener("resize", calcWindowSize);                                
            }
        }

        function initViewer(viewer) {
            // viewer.setQualityLevel(/* ambient shadows */ false, /* antialiasing */ true);
            viewer.setGroundShadow(true);
            viewer.setGroundReflection(false);
            viewer.setGhosting(true);
            viewer.setEnvMapBackground(true);
            viewer.setLightPreset(5);
            viewer.setSelectionColor(new THREE.Color(0xEBB30B));
            // viewer.loadExtension("NestedViewerExtension", { filter: ["2d"], crossSelection: true });
 
            viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, onSelectionChanged);
        }

        function onSelectionChanged(event) {
            // Let's only control selection in case of
            // single user selection
            if (event.dbIdArray.length === 1) {
                viewer.getProperties(event.dbIdArray[0], function(data) {
                    console.log(data.name);
                    if(data.name.indexOf("Column") >= 0)
                    {
                        var instanceTree = viewer.model.getData().instanceTree;
                        var parentId = instanceTree.getNodeParentId(event.dbIdArray[0])
                        viewer.select([parentId]);
                    }
                });
            }
        }

        /**
        * Autodesk.Viewing.Document.load() failure callback.
        */
        function onDocumentLoadFailure(viewerErrorCode) {
            console.error('onDocumentLoadFailure() - errorCode: ' + viewerErrorCode);
            jQuery('#viewer').html('<p>Translation in progress... Please try refreshing the page.</p>');
        }

        // Get Query string from URL,
        // we will use this to get the value of 'urn' from URL
        function getUrlParameter(name) {
            name = name.replace(/[[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Get public access token for read only,
        // using ajax to access route /api/forge/oauth/public in the background
        function getForgeToken(callback) {
            jQuery.ajax({
                url: '/api/forge/oauth/public',
                success: function (res) {
                    callback(res.access_token, res.expires_in);
                }
            });
        }
        
  </script>
</body>

</html>